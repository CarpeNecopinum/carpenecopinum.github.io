<!DOCTYPE html>
<html>
    <head>
        <title>Minecraft PixelArt Summoner</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
        
        <style type="text/css">
            #main {
                max-width: 800px;
                margin: 32px auto;
            }

            textarea { font-family: monospace; }
        </style>
        
    </head>
    <body>
        <div id="main">
            <h1>Minecraft PixelArt Summoner</h1>
            <form id="input" onsubmit="return false">
                <div class="form-group">
                    <label>Input Image URL:</label>
                    <input class="form-control" type="file" name="image">
                </div>
                <div class="form-group">
                    <label>x-Axis Slicing (0 = disable slicing):</label>
                    <input type="number" class="form-control" name="slicing" value="0" min="0" max="64">
                </div>
            </form>   
            <img id="preview" src="" alt="">
            
            <hr>
            
            <div id="toolong" class="alert alert-danger" style="display:none">
                Warning: Some of the outputs are too long, use slicing with a smaller slice width or your client will crash!
            </div>
            
            <div id="results">
                
            </div>
        </div>
    </body>
    <script type="text/javascript">
        var preview = document.getElementById("preview");
        var sliceField = document.forms["input"].slicing;
        var resultDiv = document.getElementById("results");
        var tooLongdiv = document.getElementById("toolong");
                
        function update()
        {
            var file = document.forms["input"].image.files[0];
            
            var reader = new FileReader();
            reader.onload = function(e)
            {
                preview.src = this.result;
                
                var canvas = document.createElement("canvas");
                canvas.width = preview.width;
                canvas.height = preview.height;
                var context = canvas.getContext('2d');
                context.drawImage(preview, 0, 0, preview.width, preview.height);  
                
                generate(context, preview.width, preview.height);
            };
            reader.readAsDataURL(file);
            
        };
        
        function generate(context, width, height)
        { 
            tooLongdiv.style.display = "none";
            
            var list = generateStacks(context, width, height);
            console.debug(list);
            
            var slices = [];
            var sliceWidth = parseInt(sliceField.value);
            if (sliceWidth != 0)
            {
                for (var x = 0; x < list.length; x += sliceWidth)
                {
                    slices.push(list.slice(x, x + sliceWidth));
                }
            } else {
                slices.push(list);
            }
            
            resultDiv.innerHTML = "";
            
            console.debug(slices);
            for (var i = 0; i < slices.length; i++)
            {
                var result;
                
                var slice = slices[i];
                if (slice.length == 1)
                {
                    result = generateCode(slice, i+1);
                } 
                else
                {
                    var builders = [];
                    //Add a deleter for the builders
                    builders.push({id: 'FallingSand', Time: 99, TileID: 152});
                    builders.push({id: 'FallingSand', Time: 99, TileID: 137, TileEntityData: {Command: "/fill ~ ~1 ~ ~ ~-" + 2 * slice.length + " ~ air"}});
            
                    for (var x = 0; x < slice.length; x++)
                        builders = builders.concat(generateBuilder(slice[x], i * sliceWidth + x + 1));                    
                    
                    result = generateCode(builders, 1);
                }

                var output = document.createElement("textarea");
                output.className = "form-control";
                output.value = result;
                
                if (result.length > 32767) tooLongdiv.style.display = "block";
                
                resultDiv.appendChild(output);
            }
        }
        
        function generateBuilder(column, offset)
        {
            var result = [];
            result.push({id: 'FallingSand', Time: 99, TileID: 152});
            result.push({id: 'FallingSand', Time: 99, TileID: 137, TileEntityData: {Command: generateCode(column, offset)}});
            return result;
        }
        
        function generateStacks(context, width, height)
        {
            var result = [];
            for (var x = 0; x < width; x++)
                result.push(generateStack(context.getImageData(x,0,1,height)));
            return result;
        }
        
        function generateStack(rawData)
        {
            var result = [];
            for (var y = 0; y < rawData.height; y++)
                result.push(findBlock(rawData.data.subarray(y*4,y*4 + 3)));
            return result;
        }
        
        var wools = [
            [215,213,210],
            [176,105,52],
            [157,88,130],
            [99,117,157],
            [197,174,76],
            [138,149,77],
            [237,155,156],
            [92,93,93],
            [168,169,169],
            [85,119,114],
            [106,47,111],
            [42,59,114],
            [114,73,38],
            [75,82,39],
            [175,51,37],
            [43,44,45]
        ];
        
        function findBlock(rgb)
        {
            var difference = percievedDiff(rgb, wools[0]);
            var color = 0;
            
            for (var i = 1; i < wools.length; i++)
            {
                var diff = percievedDiff(rgb, wools[i]);
                if (diff < difference)
                {
                    difference = diff;
                    color = i;
                }
            }
            
            return {id: 'FallingSand', TileID: 35, Data: color, Time: 99}; 
        }
        
        function percievedDiff(colorA, colorB)
        {
            hsA = rgb2hsv(colorA);
            hsB = rgb2hsv(colorB);
            
            return Math.abs(hsA.h - hsB.h) * hsA.s 
                 + Math.abs(hsA.s - hsB.s)
                 + Math.abs(hsA.v - hsB.v);
        }
        
        function generateCode(list, shift)
        {
            var root = list[0];
            var current = root;

            for (var i = 1; i < list.length; i++)
            {
                current["Riding"] = list[i];
                current = list[i];
            }

            var id = root["id"];
            delete root["id"];

            return "/summon " + id + " ~" + shift + " ~1" + " ~ " + toMcJson(root);
        }

        function toMcJson(item)
        {
            if (item instanceof Array)
            {
                var result = "[";
                for (var i = 0; i < item.length; i++)
                {
                    result += toMcJson(item[i]) + ",";
                }
                return result.slice(0,-1) + "]";
            }
            if (typeof item == "object")
            {
                var result = "{";
                for (var key in item)
                {
                    result += key + ":" + (key == "Riding" ? "\n" : "") + toMcJson(item[key]) + ",";
                }
                return result.slice(0,-1) + "}";
            }
            if (typeof item == "string")
            {
                return '"' + item.replace(/\\/g, "\\\\").replace(/\"/g, "\\\"") + '"';
            }

            return "" + item;
        }
        
        function rgb2hsv (rgb) {
            var rr, gg, bb,
                r = rgb[0] / 255,
                g = rgb[1] / 255,
                b = rgb[2] / 255,
                h, s,
                v = Math.max(r, g, b),
                diff = v - Math.min(r, g, b),
                diffc = function(c){
                    return (v - c) / 6 / diff + 1 / 2;
                };

            if (diff == 0) {
                h = s = 0;
            } else {
                s = diff / v;
                rr = diffc(r);
                gg = diffc(g);
                bb = diffc(b);

                if (r === v) {
                    h = bb - gg;
                }else if (g === v) {
                    h = (1 / 3) + rr - bb;
                }else if (b === v) {
                    h = (2 / 3) + gg - rr;
                }
                if (h < 0) {
                    h += 1;
                }else if (h > 1) {
                    h -= 1;
                }
            }
            return {
                h: Math.round(h * 360),
                s: Math.round(s * 100),
                v: Math.round(v * 100)
            };
        }
        
        document.forms["input"].image.onchange = update; 
        document.forms["input"].slicing.onchange = update;
    </script>
</html>
